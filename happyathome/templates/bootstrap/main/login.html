{% extends "bootstrap/base.html" %}
{% from "bootstrap/main/_formhelpers.html" import render_field %}


{% block content %}
<div class="contentwrap">
    <article class="container">
        <div class="page-header">
            <h1>로그인</h1>
        </div>
        <form class="form-horizontal" method="POST">
            <div class="form-group">
                <div class="col-sm-4">
                    {{ form.email(class="form-control", placeholder=form.email.label.text) }}
                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-4">
                    {{ form.password(class="form-control", placeholder=form.password.label.text) }}
                </div>
            </div>
            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <ul>
                {% for message in messages %}
                <li>{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            {% endwith %}
            <button type="submit" class="btn btn-primary">로그인</button>
        </form>

        <!--facebook login-->
        <div class="col-sm-4">
            <form name="fbForm" class="form-group" method="post">
                <button type="button" id="fb-btn" class="btn btn-primary">facebook로그인</button>
            </form>
        </div>
        <!--kakao login
        <a id="custom-login-btn" href="javascript:loginWithKakao()">
            <img src="http://mud-kage.kakao.co.kr/14/dn/btqbjxsO6vP/KPiGpdnsubSq3a0PHEGUK1/o.jpg" width="150"/>
        </a>
        <!--google login-->
        <!--  <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>-->
    </article>
</div>


<!--facebook login-->
<script>
        //button event
         $('#fb-btn').click(function () {
             facebookRegist();
         });


        // 페이스북 SDK 초기화
        window.fbAsyncInit = function () {
            FB.init({
                appId: '1743693419236952'    // Website with Facebook Login 사이트 : 일단 test 용으로 용퓌 계정상에서 app 생성
                , status: true   // check login status
                , cookie: true   // enable cookies to allow the server to access the session
                , xfbml: true    // parse XFBML
                //, oauth: true
            });
        };

        // 페이스북 SDK(js) 로딩 (페이지 로딩 속도 향상을 위해 사용)
        (function (d) {
            var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement('script');
            js.id = id;
            js.async = true;
            //js.src = "//connect.facebook.net/en_US/all.js";
            js.src = "http://connect.facebook.net/ko_KR/all.js";
            ref.parentNode.insertBefore(js, ref);
        }(document));

         // 페이스북 계정으로 회원 가입
        function facebookRegist() {
             alert(1);
            // 페이스북 로그인 상태 체크
            FB.getLoginStatus(function (response) {

                if (response.status == "connected") {
                    // 페이스북 로그인 YES! and 앱 허가 YES!
                            alert(2);
                    handleFacebookRegist(response);

                } else if (response.status == "not_authorized") {
                    // 페이스북 로그인 YES! but 앱 허가 NO!
                    FB.login(function (response) {
                            alert(3);
                                handleFacebookRegist(response);
                            }, {scope: 'publish_stream, email, user_birthday, user_likes, publish_actions, read_stream'});
                } else {    // 페이스북 로그아웃 상태.
                    FB.login(function (response) {
                    alert(4);
                                handleFacebookRegist(response);
                            },{scope: 'publish_stream, email, user_birthday, user_likes, publish_actions, read_stream'});
                }
            });
        }

        // 회원가입 핸들러
        function handleFacebookRegist(response) {

            var accessToken = response.authResponse.accessToken;
            var userId, userName, fbId, userBirth;

            FB.api('/me', function (user) {
                userId = user.email;    // 페이스북 email
                userName = user.name;   // 페이스북 name
                fbId = user.id;         // 페이스북 id
                userBirth = user.birthday;  // 페이스북 생일 : mm/dd/yyyy
                alert(accessToken);
                alert(userName);
                alert(userBirth);
                $('input[name=fbAccessToken]').val(accessToken);

                $.ajax({
                    type: "post",
                    url: "/login/facebook",
                    dataType: "json",
                    json: "callback",
                    data: {
                        accessToken: accessToken
                    },
                    beforeSend: function () {
                        $('#ajax_load_indicator').fadeIn('fast');
                    },
                    success: function (data) {
                        if (data.result == true) {
                            alert("이미 가입이 되어있습니다.");
                            return;
                        } else {
                            if (confirm("Facebook 계정으로 가입하시겠습니까?\n\rFacebook 계정으로 가입시 추가정보를 입력하셔야 합니다.")) {
                                //var $form = $("<form></form>");
                                //$form.attr("action",'/login/facebooksignup');
                                //$form.attr("method","post");
                                //$form.appendTo("body");
                                //$form.append("<input type="hidden" name="userName" value=""+ userName +"">");
                                //$form.append("<input type="hidden" name="userId" value=""+ userId +"">");
                                //$form.append("<input type="hidden" name="fbId" value=""+ fbId +"">");
                                //$form.append("<input type="hidden" name="userBirth" value=""+ userBirth +"">");    // mm/dd/yyyy 형식으로 받음.(짤라서 쓰던가 하믄 됨.)
                                //$form.submit();
                            }
                            return;
                        }
                    },
                    error: function (data, status, err) {
                        alert("서버와의 통신이 실패했습니다.");
                        alert(err)
                        return;
                    },
                    complete: function () {
                        $('#ajax_load_indicator').fadeOut();
                    }
                });
            });
        }




</script>

<!--kakao login-->
<script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
<script type='text/javascript'>
  //<![CDATA[
    // 사용할 앱의 JavaScript 키를 설정해 주세요.
    Kakao.init('073f6b19b39951b4ae75599f4e74079a');
    function loginWithKakao() {
      // 로그인 창을 띄웁니다.
      Kakao.Auth.login({
        success: function(authObj) {
            //로그인 완료
        },
        fail: function(err) {
          alert(JSON.stringify(err));
        }
      });
    };
  //]]>



</script>

<!--google login-->
<meta name="google-signin-client_id" content="443256889958-198b1okbcp4bv3a5vjr2brrcajhsemec.apps.googleusercontent.com">
<script src="https://apis.google.com/js/platform.js" async defer></script>
<script>
      function onSignIn(googleUser) {
        // Useful data for your client-side scripts:
        var profile = googleUser.getBasicProfile();
        console.log("ID: " + profile.getId()); // Don't send this directly to your server!
        console.log('Full Name: ' + profile.getName());
        console.log('Given Name: ' + profile.getGivenName());
        console.log('Family Name: ' + profile.getFamilyName());
        console.log("Image URL: " + profile.getImageUrl());
        console.log("Email: " + profile.getEmail());

        // The ID token you need to pass to your backend:
        var id_token = googleUser.getAuthResponse().id_token;
        console.log("ID Token: " + id_token);
      };


</script>

{% endblock %}