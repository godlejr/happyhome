{% extends 'bootstrap/photos/base.html' %}

{% block content %}
<div class="content">
    <div class="well">
        <form method="POST" id="photoForm" class="form-horizontal">
            <fieldset>
                <legend>사진을 등록해주세요.</legend>

                <div class="form-group photo-file-form">
                    <div class="photo-preview" id="photoPreview"></div>
                    <div class="photo-preview-loading"></div>
                    <input type="file" class="photo-file" id="photoFile" name="photo_file" />
                    <input type="hidden" id="photoFileId" name="file_id" />
                    <input type="hidden" id="photoFileName" name="file_name" />
                </div>

                <div class="form-group">
                    <div class="col-lg-10 col-lg-offset-1">
                        <input type="checkbox" id="contentType" name="content_type" value="2"><label for="contentType">360 VR 이미지입니다.</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="btn-group col-lg-10 col-lg-offset-1" data-toggle="buttons">
                        {% for room in rooms %}
                        <label class="btn btn-primary">
                            <input type="radio" name="room_id" value="{{ room.id }}"> {{ room.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-lg-10 col-lg-offset-1">
                        <textarea class="form-control" rows="5" id="textArea" name="content" placeholder="사진에 대한 설명을 등록해주세요."></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-lg-10 col-lg-offset-1">
                        <button type="reset" class="btn btn-default">취소</button>
                        <button type="submit" class="btn btn-danger">등록</button>
                    </div>
                </div>
            </fieldset>
        </form>
    </div>
</div>

<script>
var $photoFile = $('#photoFile'),
    $photoPreview = $('#photoPreview'),
    $photoPreviewLoading = $('.photo-preview-loading')


$('#photoForm').submit(function() {
    window.onunload = window.onbeforeunload = undefined;

    if (!$('#photoFile').val()) {
        alert('사진 파일을 선택해주세요.');
        return false;
    }

    if (!$('input[name=room_id]:checked').val()) {
        alert('공간을 선택해주세요.');
        return false;
    }

    return true;
});


$photoPreview.click(function(e) {
    e.preventDefault();

    $photoFile.click();
});

$photoFile.change(function() {
    var ext = $(this).val().split('.').pop().toLowerCase();

    if (ext.length > 0) {
        if ($.inArray(ext, ['jpg', 'jpeg']) == -1) {
            $(this).val('');
            alert('사진 파일(jpg)만 업로드 할수 있습니다.');
            return false;
        }

        photosUnload();
        $photoPreviewLoading.show();

        var reader = new FileReader();
        reader.readAsDataURL($photoFile[0].files[0])
        reader.onload = function(e) {
            $.ajax({
                type: "POST",
                url: "{{ url_for('photos.upload') }}",
                data: {
                    file_name: $photoFile.val(),
                    file_data: e.target.result
                }
            }).success(function(data) {
                $('#photoFileId').val(data.file_id);
                $('#photoFileName').val(data.file_name);
                $photoPreview.append("<img src=http://static.inotone.co.kr/data/img/" + data.file_name + " />");
                $photoPreview.find('img').load(function() {
                    $photoPreviewLoading.hide();

                    if (this.naturalWidth / this.naturalHeight == 2) {
                        $('#contentType').prop('checked', true);
                    } else {
                        $('#contentType').prop('checked', false);
                    };
                });
            });
        }
    }
});

function photosUnload() {
    $photoPreview.children().remove();

    var $photoFileId = $('#photoFileId'),
        $photoFileName = $('#photoFileName');

    if ($photoFileName.val()) {
        $.ajax({
            type: "POST",
            async: false,
            cache: false,
            url: "{{ url_for('photos.unload') }}",
            data: {
                file_name: $photoFileName.val()
            }
        }).success(function(data) {
            $photoFileId.val('');
            $photoFileName.val('');
        });
    }
}

window.onunload = function() {
    photosUnload();
};

window.onbeforeunload = function(e) {
    e = e || window.event;
    e.returnValue = "변경사항이 저장되지 않을 수 있습니다.";
};

function loadPhoto(photoPreview, dataURL, callback) {
    var reader = new FileReader();

    reader.readAsDataURL(dataURL.files[0]);
    reader.onload = function (e) {
        var img = new Image();
        img.src = e.target.result;
        img.height = photoPreview.offsetHeight;
        img.onload = function() {
            photoPreview.appendChild(this);
            photoPreview.style.width = photoPreview.offsetHeight * (this.width / this.height);
            callback();
        };
    }
}
</script>
{% endblock %}
